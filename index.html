<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EasyTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #09090b; color: #fafafa; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24 md:pb-0 md:pt-24 bg-zinc-950">

    <header class="pt-12 pb-6 px-6 border-b border-zinc-800 bg-zinc-950/80 sticky top-0 backdrop-blur-md z-50 flex justify-between items-center max-w-5xl mx-auto md:fixed md:w-full md:max-w-none md:px-12 md:pt-6">
        <h1 class="text-3xl font-extrabold tracking-tight bg-gradient-to-r from-white to-zinc-500 bg-clip-text text-transparent">‚ö° EasyTrack</h1>
        <div id="sync-status" class="text-xs font-bold text-yellow-500 bg-yellow-500/10 px-3 py-1.5 rounded-lg border border-yellow-500/20 shadow-sm transition-colors">Connexion...</div>
    </header>

    <nav class="fixed bottom-0 w-full bg-zinc-950/90 backdrop-blur-xl border-t border-zinc-800 pb-safe z-40 md:top-24 md:bottom-auto md:w-auto md:left-1/2 md:-translate-x-1/2 md:border md:border-zinc-800 md:rounded-2xl md:px-6">
        <div class="flex justify-around p-3 md:pb-3 md:gap-8">
            <button onclick="switchTab('workouts')" class="flex flex-col items-center gap-1 text-white transition-opacity duration-200 hover:scale-105" id="nav-workouts">
                <span class="text-xl md:text-2xl">üèãÔ∏è‚Äç‚ôÇÔ∏è</span><span class="text-[10px] md:text-xs font-bold tracking-wide uppercase mt-1">S√©ances</span>
            </button>
            <button onclick="switchTab('progress')" class="flex flex-col items-center gap-1 text-white opacity-40 transition-opacity duration-200 hover:scale-105 hover:opacity-100" id="nav-progress">
                <span class="text-xl md:text-2xl">üìà</span><span class="text-[10px] md:text-xs font-bold tracking-wide uppercase mt-1">Stats</span>
            </button>
            <button onclick="switchTab('visbody')" class="flex flex-col items-center gap-1 text-white opacity-40 transition-opacity duration-200 hover:scale-105 hover:opacity-100" id="nav-visbody">
                <span class="text-xl md:text-2xl">‚öñÔ∏è</span><span class="text-[10px] md:text-xs font-bold tracking-wide uppercase mt-1">Visbody</span>
            </button>
        </div>
    </nav>

    <main class="p-6 max-w-5xl mx-auto">
        
        <section id="tab-workouts" class="tab-content active">
            <div id="workout-list" class="space-y-6">
                <h2 class="text-2xl font-semibold text-zinc-300 mb-2">Programme de Base</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="base-workouts-container"></div>
                <h2 class="text-2xl font-semibold text-zinc-300 mt-8 mb-2">S√©ances Bonus</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="bonus-workouts-container"></div>
            </div>

            <div id="active-workout" class="hidden space-y-6">
                <div class="flex items-center justify-between mb-4 bg-zinc-900 p-4 rounded-2xl border border-zinc-800">
                    <button onclick="closeWorkout()" class="text-zinc-400 flex items-center gap-2 font-medium hover:text-white transition-colors">‚Üê Retour</button>
                    <span id="workout-title" class="font-bold text-xl text-white"></span>
                </div>
                <div id="exercises-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                <button onclick="saveWorkout()" class="w-full bg-white text-black font-extrabold text-xl py-5 rounded-2xl shadow-[0_0_20px_rgba(255,255,255,0.15)] active:scale-95 transition-transform hover:bg-zinc-200 mt-8">
                    ‚úÖ Valider la s√©ance
                </button>
            </div>
        </section>

        <section id="tab-progress" class="tab-content">
            <h2 class="text-2xl font-semibold mb-6 text-zinc-300">Progression Globale (1RM)</h2>
            <div class="mb-6 max-w-md bg-zinc-900/50 p-5 rounded-2xl border border-zinc-800 shadow-lg">
                <label class="block text-sm font-medium text-zinc-400 mb-2">S√©lectionne un exercice :</label>
                <select id="stats-exo-select" onchange="renderStatsChart()" class="w-full bg-zinc-950 border border-zinc-700 text-white text-base rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block p-3 outline-none transition-all cursor-pointer"></select>
                <div id="stats-progression" class="mt-4 text-sm text-zinc-300 text-center font-medium bg-zinc-950 py-2 rounded-lg border border-zinc-800">S√©lectionne un exo pour voir ton √©volution.</div>
            </div>
            <div class="bg-zinc-900/50 p-6 rounded-3xl border border-zinc-800 h-[400px] shadow-2xl backdrop-blur-sm">
                <canvas id="statsChart"></canvas>
            </div>
        </section>

        <section id="tab-visbody" class="tab-content">
            <div class="max-w-2xl mx-auto mb-10">
                <h2 class="text-2xl font-semibold mb-6 text-zinc-300">Bilan Visbody Pro</h2>
                <div class="bg-zinc-900/50 p-6 rounded-3xl border border-zinc-800 shadow-xl space-y-6 backdrop-blur-sm">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div><label class="text-xs font-medium text-zinc-400 mb-1 block">Poids total</label><input type="number" id="vb-weight" placeholder="kg" class="w-full bg-zinc-950 p-3 rounded-xl border border-zinc-700 text-center outline-none focus:border-white focus:ring-2 focus:ring-white/20 text-white font-bold transition-all"></div>
                        <div><label class="text-xs font-medium text-purple-400 mb-1 block">Score Sant√©</label><input type="number" id="vb-score" placeholder="0-100" class="w-full bg-zinc-950 p-3 rounded-xl border border-purple-900/50 text-center outline-none focus:border-purple-400 focus:ring-2 focus:ring-purple-500/20 text-white font-bold transition-all"></div>
                        <div><label class="text-xs font-medium text-zinc-400 mb-1 block">Masse Grasse</label><input type="number" id="vb-fat" placeholder="%" class="w-full bg-zinc-950 p-3 rounded-xl border border-zinc-700 text-center outline-none focus:border-white focus:ring-2 focus:ring-white/20 text-white font-bold transition-all"></div>
                        <div><label class="text-xs font-medium text-orange-400 mb-1 block">Muscle</label><input type="number" id="vb-muscle" placeholder="kg" class="w-full bg-zinc-950 p-3 rounded-xl border border-orange-900/50 text-center outline-none focus:border-orange-400 focus:ring-2 focus:ring-orange-500/20 text-white font-bold transition-all"></div>
                        <div><label class="text-xs font-medium text-blue-400 mb-1 block">Eau corporelle</label><input type="number" id="vb-water" placeholder="kg" class="w-full bg-zinc-950 p-3 rounded-xl border border-blue-900/50 text-center outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-500/20 text-white font-bold transition-all"></div>
                        <div><label class="text-xs font-medium text-zinc-400 mb-1 block">Os / Min√©raux</label><input type="number" id="vb-bone" placeholder="kg" class="w-full bg-zinc-950 p-3 rounded-xl border border-zinc-700 text-center outline-none focus:border-white focus:ring-2 focus:ring-white/20 text-white font-bold transition-all"></div>
                        <div><label class="text-xs font-medium text-red-400 mb-1 block">Visc√©rale</label><input type="number" id="vb-visceral" placeholder="Niv." class="w-full bg-zinc-950 p-3 rounded-xl border border-red-900/50 text-center outline-none focus:border-red-400 focus:ring-2 focus:ring-red-500/20 text-white font-bold transition-all"></div>
                        <div><label class="text-xs font-medium text-green-400 mb-1 block">M√©tabolisme</label><input type="number" id="vb-bmr" placeholder="kcal" class="w-full bg-zinc-950 p-3 rounded-xl border border-green-900/50 text-center outline-none focus:border-green-400 focus:ring-2 focus:ring-green-500/20 text-white font-bold transition-all"></div>
                    </div>
                    <button onclick="saveVisbody()" class="w-full bg-zinc-100 text-black font-extrabold py-3 rounded-xl active:scale-95 transition-transform hover:bg-white text-lg shadow-lg">Enregistrer l'analyse</button>
                </div>
            </div>

            <h2 class="text-2xl font-semibold mb-6 text-zinc-300">Tableau de bord de l'√©volution</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-white mb-2 uppercase tracking-wider text-center">Poids total (kg)</h3><div class="flex-grow relative"><canvas id="vbChart-weight"></canvas></div></div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-purple-900/30 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-purple-400 mb-2 uppercase tracking-wider text-center">Score Sant√©</h3><div class="flex-grow relative"><canvas id="vbChart-score"></canvas></div></div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-zinc-400 mb-2 uppercase tracking-wider text-center">Masse Grasse (%)</h3><div class="flex-grow relative"><canvas id="vbChart-fat"></canvas></div></div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-orange-900/30 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-orange-400 mb-2 uppercase tracking-wider text-center">Muscle (kg)</h3><div class="flex-grow relative"><canvas id="vbChart-muscle"></canvas></div></div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-blue-900/30 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-blue-400 mb-2 uppercase tracking-wider text-center">Eau Corporelle (kg)</h3><div class="flex-grow relative"><canvas id="vbChart-water"></canvas></div></div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-zinc-800 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-zinc-400 mb-2 uppercase tracking-wider text-center">Os / Min√©raux (kg)</h3><div class="flex-grow relative"><canvas id="vbChart-bone"></canvas></div></div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-red-900/30 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-red-400 mb-2 uppercase tracking-wider text-center">Graisse Visc√©rale</h3><div class="flex-grow relative"><canvas id="vbChart-visceral"></canvas></div></div>
                <div class="bg-zinc-900/50 p-4 rounded-2xl border border-green-900/30 shadow-lg backdrop-blur-sm h-48 flex flex-col"><h3 class="text-xs font-bold text-green-400 mb-2 uppercase tracking-wider text-center">M√©tabolisme (kcal)</h3><div class="flex-grow relative"><canvas id="vbChart-bmr"></canvas></div></div>
            </div>
        </section>

    </main>

    <script>
        // Tes cl√©s Supabase
        const SUPABASE_URL = 'https://vqtwxbsaieuajaddvbsj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxdHd4YnNhaWV1YWphZGR2YnNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjQ4MDQsImV4cCI6MjA4NzgwMDgwNH0.dGoigHDlSDxNELv07EL95-0N_Q6Q4aCrSVFC3jG2jyE';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let globalWorkoutHistory = [];
        let globalVisbodyData = [];

        // BASE DE DONN√âES DES PROGRAMMES
        const workoutsData = [
            { id: 'push', type: 'base', name: 'S√©ance Push', color: 'from-blue-600 to-blue-900', exercises: ['D√©velopp√© couch√©', 'Chest press inclin√©e', 'D√©velopp√© militaire', 'Triceps barre droite', 'Triceps barre V'] },
            { id: 'pull', type: 'base', name: 'S√©ance Pull', color: 'from-emerald-600 to-emerald-900', exercises: ['Tirage vertical', 'Tirage horizontal', 'Rowing', 'Biceps poulie', 'Curl marteau'] },
            { id: 'legs', type: 'base', name: 'S√©ance Legs', color: 'from-orange-600 to-orange-900', exercises: ['Squat pendulum', 'Soulev√© de terre roumain', 'Presse', 'Leg extension', 'Leg curl', 'Mollets'] },
            { id: 'bonus_fb', type: 'bonus', name: 'Full Body (G√©n√©ral)', color: 'from-purple-600 to-purple-900', exercises: ['Fentes bulgares', 'D√©velopp√© inclin√© halt√®res', 'Tirage poitrine', '√âl√©vations lat√©rales', 'Curl pupitre', 'Abdos'] },
            { id: 'bonus_arms', type: 'bonus', name: 'Focus Bras & √âpaules', color: 'from-pink-600 to-pink-900', exercises: ['Curl barre', 'Extension triceps poulie', '√âl√©vations lat√©rales', 'Face pull', 'Curl marteau', 'Dips'] },
            { id: 'bonus_weak', type: 'bonus', name: 'Points Faibles (Dos/Pecs)', color: 'from-red-600 to-red-900', exercises: ['Pull-over', '√âcart√© poulie vis-√†-vis', 'Tirage bras tendus', 'Oiseau halt√®res', 'Shrugs'] }
        ];

        // üì∏ LE FAMEUX DICTIONNAIRE COMPLET DES PHOTOS (31 EXERCICES)
        // Remplace simplement les liens commen√ßant par "https://placehold.co/..." par tes propres liens Google Images !
        const exerciseImages = {
            // --- S√âANCE PUSH ---
            'D√©velopp√© couch√©': 'https://blog.myarsenalstrength.com/hs-fs/hubfs/Screenshot%202024-07-24%20at%209.54.41%20AM.png?width=460&height=388&name=Screenshot%202024-07-24%20at%209.54.41%20AM.png',
            'Chest press inclin√©e': 'https://i.pinimg.com/originals/df/fd/85/dffd856bea5056e1adbb683c6ea54613.gif',
            'D√©velopp√© militaire': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Dumbbell-Shoulder-Press.gif',
            'Triceps barre droite': 'https://fitliferegime.com/wp-content/uploads/2023/06/Triceps-Pushdown.gif',
            'Triceps barre V': 'https://fitnessprogramer.com/wp-content/uploads/2022/02/V-bar-Pushdown.gif',

            // --- S√âANCE PULL ---
            'Tirage vertical': 'https://pump-app.s3.eu-west-2.amazonaws.com/exercise-assets/12041101-Cable-one-arm-lat-pulldown_back_small.jpg',
            'Tirage horizontal': 'https://images.squarespace-cdn.com/content/v1/5ffcea9416aee143500ea103/1638351904146-GDGXXL9IHXKQKTXULLHF/Seated%2BCable%2BRow.jpeg',
            'Rowing': 'https://training.fit/wp-content/uploads/2020/02/rudern-langhantel.png',
            'Biceps poulie': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/One-Arm-Cable-Curl.gif',
            'Curl marteau': 'https://fitnessprogramer.com/wp-content/uploads/2021/02/Hammer-Curl.gif',

            // --- S√âANCE LEGS ---
            'Squat pendulum': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Squat+Pendulum',
            'Soulev√© de terre roumain': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Soulev√©+Terre+R.',
            'Presse': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Presse+Cuisses',
            'Leg extension': 'https://www.gymchalo.com/cdn/shop/articles/leg-extension-anatomy.jpg', // Le vrai lien d'exemple
            'Leg curl': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Leg+Curl',
            'Mollets': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Mollets',

            // --- BONUS FULL BODY ---
            'Fentes bulgares': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Fentes+Bulgares',
            'D√©velopp√© inclin√© halt√®res': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Dev.+Inclin√©',
            'Tirage poitrine': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Tirage+Poitrine',
            '√âl√©vations lat√©rales': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Elevations+Lat.',
            'Curl pupitre': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Curl+Pupitre',
            'Abdos': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Abdos',

            // --- BONUS BRAS & √âPAULES ---
            'Curl barre': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Curl+Barre',
            'Extension triceps poulie': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Extension+Triceps',
            'Face pull': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Face+Pull',
            'Dips': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Dips',

            // --- BONUS POINTS FAIBLES ---
            'Pull-over': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Pull-over',
            '√âcart√© poulie vis-√†-vis': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Ecart√©+Poulie',
            'Tirage bras tendus': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Bras+Tendus',
            'Oiseau halt√®res': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Oiseau',
            'Shrugs': 'https://placehold.co/600x400/18181b/ef4444?text=Anatomie:+Shrugs'
        };

        let currentWorkoutId = null;
        let sChart = null;
        let vbCharts = {}; 

        function getLocalIsoDate() {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        function formatPrettyDate(isoDateString) {
            return new Date(isoDateString).toLocaleDateString('fr-FR', {day: '2-digit', month: 'short'});
        }

        async function loadDataFromCloud() {
            const statusBadge = document.getElementById('sync-status');
            
            const { data: workouts } = await supabaseClient.from('workouts').select('*').order('date', { ascending: true });
            if (workouts) globalWorkoutHistory = workouts;

            const { data: visbody } = await supabaseClient.from('visbody').select('*').order('date', { ascending: true });
            if (visbody) globalVisbodyData = visbody;

            statusBadge.innerText = "Connect√© ‚úÖ";
            statusBadge.className = "text-xs font-bold text-emerald-500 bg-emerald-500/10 px-3 py-1.5 rounded-lg border border-emerald-500/20 shadow-sm transition-colors";

            populateStatsSelect();
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderWorkoutList();
            loadDataFromCloud();
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.replace('opacity-100', 'opacity-40') || btn.classList.replace('opacity-40', 'opacity-40'));
            document.getElementById('nav-' + tabId).classList.replace('opacity-40', 'opacity-100');

            if(tabId === 'visbody') renderAllVisbodyCharts();
            if(tabId === 'progress') renderStatsChart();
        }

        function renderWorkoutList() {
            const baseContainer = document.getElementById('base-workouts-container');
            const bonusContainer = document.getElementById('bonus-workouts-container');
            baseContainer.innerHTML = ''; bonusContainer.innerHTML = '';

            workoutsData.forEach(w => {
                const card = `
                    <button onclick="openWorkout('${w.id}')" class="w-full h-full bg-gradient-to-br ${w.color} p-6 rounded-3xl flex flex-col justify-center items-start shadow-xl active:scale-95 transition-all hover:scale-[1.02] text-left border border-white/10 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-40 transition-opacity transform group-hover:scale-110">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                        </div>
                        <h3 class="text-2xl font-black text-white mb-2 relative z-10">${w.name}</h3>
                        <p class="text-white/80 text-sm font-semibold relative z-10 bg-black/20 px-3 py-1 rounded-full">${w.exercises.length} exercices</p>
                    </button>
                `;
                if(w.type === 'base') baseContainer.innerHTML += card;
                else bonusContainer.innerHTML += card;
            });
        }

        // üì∏ FONCTION POUR AFFICHER/CACHER L'IMAGE
        window.togglePhoto = function(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        };

        function openWorkout(id) {
            currentWorkoutId = id;
            const workout = workoutsData.find(w => w.id === id);
            document.getElementById('workout-list').classList.add('hidden');
            document.getElementById('workout-title').innerText = workout.name;
            document.getElementById('active-workout').classList.remove('hidden');
            
            const exoList = document.getElementById('exercises-list');
            exoList.innerHTML = '';

            workout.exercises.forEach((exo, exoIndex) => {
                let prevText = "Pas de record";
                for(let i = globalWorkoutHistory.length - 1; i >= 0; i--) {
                    if(globalWorkoutHistory[i].data[exo]) {
                        const bestSet = globalWorkoutHistory[i].data[exo][0];
                        prevText = `Dernier : ${bestSet.weight}kg x ${bestSet.reps}`;
                        break;
                    }
                }

                // üì∏ R√©cup√©ration de l'image (soit dans le dico, soit une image par d√©faut)
                const imgUrl = exerciseImages[exo] || `https://placehold.co/600x300/18181b/3b82f6?text=${encodeURIComponent(exo)}`;

                let html = `
                    <div class="bg-zinc-900/80 p-5 rounded-3xl border border-zinc-800 shadow-md backdrop-blur-sm transition-colors hover:border-zinc-700">
                        <div class="mb-4 flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg text-white">${exo}</h3>
                                <button onclick="togglePhoto('img-${exoIndex}')" class="text-xs text-blue-400 mt-1 flex items-center gap-1 hover:text-blue-300">üì∏ Afficher/Cacher la photo</button>
                            </div>
                            <span class="text-xs bg-blue-500/10 text-blue-400 border border-blue-500/20 px-3 py-1.5 rounded-lg font-bold">${prevText}</span>
                        </div>
                        
                        <div id="img-${exoIndex}" class="hidden mb-4 rounded-xl overflow-hidden border border-zinc-700/50">
                            <img src="${imgUrl}" alt="${exo}" class="w-full h-40 object-cover opacity-90">
                        </div>

                        <div class="space-y-3">
                `;
                
                for(let i=0; i<3; i++) {
                    html += `
                        <div class="flex gap-3 items-center bg-zinc-950/50 p-2 rounded-xl">
                            <span class="text-zinc-500 font-bold text-sm w-8 text-center">S${i+1}</span>
                            <input type="number" id="val-${exoIndex}-set-${i}-w" placeholder="Kg" class="w-1/2 bg-zinc-900 p-3 rounded-lg border border-zinc-700 text-center outline-none focus:border-white focus:ring-1 focus:ring-white text-white font-bold transition-all">
                            <input type="number" id="val-${exoIndex}-set-${i}-r" placeholder="Reps" class="w-1/2 bg-zinc-900 p-3 rounded-lg border border-zinc-700 text-center outline-none focus:border-white focus:ring-1 focus:ring-white text-white font-bold transition-all">
                        </div>
                    `;
                }
                html += `</div></div>`;
                exoList.innerHTML += html;
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function closeWorkout() {
            document.getElementById('active-workout').classList.add('hidden');
            document.getElementById('workout-list').classList.remove('hidden');
            currentWorkoutId = null;
        }

        async function saveWorkout() {
            const workout = workoutsData.find(w => w.id === currentWorkoutId);
            const sessionData = {};
            let hasData = false;

            workout.exercises.forEach((exo, exoIndex) => {
                const sets = [];
                for(let i=0; i<3; i++) {
                    const w = document.getElementById(`val-${exoIndex}-set-${i}-w`).value;
                    const r = document.getElementById(`val-${exoIndex}-set-${i}-r`).value;
                    if(w || r) {
                        sets.push({ weight: parseFloat(w)||0, reps: parseInt(r)||0 });
                        hasData = true;
                    }
                }
                if(sets.length > 0) sessionData[exo] = sets;
            });

            if(!hasData) return alert("Tu n'as rien rempli !");

            const isoDate = getLocalIsoDate();

            document.getElementById('sync-status').innerText = "Envoi...";
            const { error } = await supabaseClient.from('workouts').insert([
                { date: isoDate, workout_id: currentWorkoutId, data: sessionData }
            ]);

            if(error) alert("Erreur : " + error.message);
            else {
                alert("üí™ S√©ance enregistr√©e avec succ√®s !");
                await loadDataFromCloud();
                closeWorkout();
            }
        }

        async function saveVisbody() {
            const payload = {
                weight: document.getElementById('vb-weight').value,
                score: document.getElementById('vb-score').value,
                fat: document.getElementById('vb-fat').value,
                muscle: document.getElementById('vb-muscle').value,
                water: document.getElementById('vb-water').value,
                bone: document.getElementById('vb-bone').value,
                visceral: document.getElementById('vb-visceral').value,
                bmr: document.getElementById('vb-bmr').value
            };

            if (!payload.weight && !payload.muscle && !payload.fat) return alert('Renseigne au moins une donn√©e principale !');

            document.getElementById('sync-status').innerText = "Envoi...";
            
            const insertData = { date: getLocalIsoDate() };
            for (const key in payload) { insertData[key] = parseFloat(payload[key]) || null; }

            const { error } = await supabaseClient.from('visbody').insert([insertData]);

            if(error) alert("Erreur : " + error.message);
            else {
                for (const key in payload) { document.getElementById('vb-' + key).value = ''; }
                await loadDataFromCloud();
                renderAllVisbodyCharts();
            }
        }

        const visbodyConfig = [
            { id: 'weight', color: '#ffffff', bg: 'rgba(255,255,255,0.1)' },
            { id: 'score', color: '#c084fc', bg: 'rgba(192,132,252,0.1)' },
            { id: 'fat', color: '#a1a1aa', bg: 'rgba(161,161,170,0.1)' },
            { id: 'muscle', color: '#fb923c', bg: 'rgba(251,146,60,0.1)' },
            { id: 'water', color: '#60a5fa', bg: 'rgba(96,165,250,0.1)' },
            { id: 'bone', color: '#d4d4d8', bg: 'rgba(212,212,216,0.1)' },
            { id: 'visceral', color: '#f87171', bg: 'rgba(248,113,113,0.1)' },
            { id: 'bmr', color: '#4ade80', bg: 'rgba(74,222,128,0.1)' }
        ];

        function renderAllVisbodyCharts() {
            visbodyConfig.forEach(config => {
                const canvas = document.getElementById(`vbChart-${config.id}`);
                if(!canvas) return; 
                const ctx = canvas.getContext('2d');
                if (vbCharts[config.id]) vbCharts[config.id].destroy();

                let gradient = ctx.createLinearGradient(0, 0, 0, 150);
                gradient.addColorStop(0, config.bg);
                gradient.addColorStop(1, 'rgba(0,0,0,0)');

                vbCharts[config.id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: globalVisbodyData.map(d => formatPrettyDate(d.date)),
                        datasets: [{
                            data: globalVisbodyData.map(d => d[config.id]),
                            borderColor: config.color, backgroundColor: gradient,
                            fill: true, tension: 0.4, borderWidth: 2,
                            pointBackgroundColor: '#000', pointBorderColor: config.color, pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { titleFont: {size: 10}, bodyFont: {size: 11, weight: 'bold'}, padding: 8 } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a', font: {size: 10} } },
                            x: { grid: { display: false }, ticks: { color: '#71717a', font: {size: 10}, maxRotation: 0 } }
                        }
                    }
                });
            });
        }

        // --- STATS FORCE (Calcul 1RM + %) ---
        function populateStatsSelect() {
            const select = document.getElementById('stats-exo-select');
            const currentSelection = select.value;
            let allExos = [...new Set(workoutsData.flatMap(w => w.exercises))].sort(); 
            
            select.innerHTML = '';
            allExos.forEach(exo => { select.innerHTML += `<option value="${exo}">${exo}</option>`; });
            if(currentSelection && allExos.includes(currentSelection)) select.value = currentSelection;
        }

        function renderStatsChart() {
            const selectedExo = document.getElementById('stats-exo-select').value;
            const chartData = [];
            
            globalWorkoutHistory.forEach(session => {
                if(session.data[selectedExo]) {
                    // Calcul 1RM Estim√© (Formule Epley)
                    const best1RM = Math.max(...session.data[selectedExo].map(set => {
                        return Math.round(set.weight * (1 + set.reps / 30));
                    }));
                    chartData.push({ date: session.date, score: best1RM });
                }
            });

            // Pourcentage de progression
            const progDiv = document.getElementById('stats-progression');
            if(chartData.length >= 2) {
                const firstPerf = chartData[0].score;
                const lastPerf = chartData[chartData.length - 1].score;
                if(firstPerf > 0) {
                    const diff = (((lastPerf - firstPerf) / firstPerf) * 100).toFixed(1);
                    const sign = diff >= 0 ? '+' : '';
                    const colorClass = diff >= 0 ? 'text-emerald-400' : 'text-red-400';
                    progDiv.innerHTML = `Perf globale : <span class="${colorClass} font-bold text-lg">${sign}${diff}%</span> depuis le d√©but üöÄ`;
                }
            } else {
                progDiv.innerHTML = 'Fais au moins 2 s√©ances pour voir ton √©volution !';
            }

            const ctx = document.getElementById('statsChart').getContext('2d');
            if (sChart) sChart.destroy();

            let gradientForce = ctx.createLinearGradient(0, 0, 0, 400);
            gradientForce.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
            gradientForce.addColorStop(1, 'rgba(30, 58, 138, 0.2)');

            sChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => formatPrettyDate(d.date)),
                    datasets: [{
                        label: 'Perf Globale (1RM en kg)',
                        data: chartData.map(d => d.score),
                        backgroundColor: gradientForce,
                        borderColor: '#3b82f6',
                        borderWidth: 1, borderRadius: 6,
                        hoverBackgroundColor: '#60a5fa'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleFont: {size: 14}, bodyFont: {size: 14, weight: 'bold'}, padding: 12, cornerRadius: 8 } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a1a1aa', font: {family: 'system-ui'} }, beginAtZero: false },
                        x: { grid: { display: false }, ticks: { color: '#a1a1aa', font: {family: 'system-ui'} } }
                    }
                }
            });
        }
    </script>
</body>
</html>
